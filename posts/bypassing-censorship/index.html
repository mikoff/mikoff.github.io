<!doctype html><html lang=en><head><title>Bypassing censorship: tools and services · Aleksandr Mikoff's blog
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Aleksandr Mikoff"><meta name=description content="Bypassing the censorship in Russia Link to heading The level of censorship in Russia has been increasing over last few decades and was pushed to the new heights after the war has started. In the following post I would like to discuss the options we have to bypass the restrictions (of course you can just buy VPN subscription and be done with that, but we are the engineers, right?)."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Bypassing censorship: tools and services"><meta name=twitter:description content="Bypassing the censorship in Russia Link to heading The level of censorship in Russia has been increasing over last few decades and was pushed to the new heights after the war has started. In the following post I would like to discuss the options we have to bypass the restrictions (of course you can just buy VPN subscription and be done with that, but we are the engineers, right?)."><meta property="og:title" content="Bypassing censorship: tools and services"><meta property="og:description" content="Bypassing the censorship in Russia Link to heading The level of censorship in Russia has been increasing over last few decades and was pushed to the new heights after the war has started. In the following post I would like to discuss the options we have to bypass the restrictions (of course you can just buy VPN subscription and be done with that, but we are the engineers, right?)."><meta property="og:type" content="article"><meta property="og:url" content="https://mikoff.github.io/posts/bypassing-censorship/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-14T21:00:00+03:00"><meta property="article:modified_time" content="2022-06-14T21:00:00+03:00"><link rel=canonical href=https://mikoff.github.io/posts/bypassing-censorship/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/image.min.c1a5dfc6bac0eb1b85bcd8abf8aba0d18e0bf02fc972f9a0b17d2962f5ca8dd5.css integrity="sha256-waXfxrrA6xuFvNir+Kug0Y4L8C/JcvmgsX0pYvXKjdU=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/spoiler.min.bf901294afff95f520a8150a4df4249576eb9c49c4f40f5f9c2de750588dd594.css integrity="sha256-v5ASlK//lfUgqBUKTfQklXbrnEnE9A9fnC3nUFiN1ZQ=" crossorigin=anonymous media=screen><link rel=stylesheet href=/plugins/academic-icons/css/academicons.min.f6abb61f6b9b2e784eba22dfb93cd399ce30ee01825791830a2737d6bfcd2be9.css integrity="sha256-9qu2H2ubLnhOuiLfuTzTmc4w7gGCV5GDCic31r/NK+k=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://mikoff.github.io/>Aleksandr Mikoff's blog
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/tags>Tags</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://mikoff.github.io/posts/bypassing-censorship/>Bypassing censorship: tools and services</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2022-06-14T21:00:00+03:00>June 14, 2022
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
8-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/vpn/>VPN</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/censorship/>Censorship</a></span></div></div></header><div class=post-content><h1 id=bypassing-the-censorship-in-russia>Bypassing the censorship in Russia
<a class=heading-link href=#bypassing-the-censorship-in-russia><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>The level of censorship in Russia has been increasing over last few decades and was pushed to the new heights after the war has started. In the following post I would like to discuss the options we have to bypass the restrictions (of course you can just buy VPN subscription and be done with that, but we are the engineers, right?).</p><p>Suppose we are connected to our network provider and want to access the resource that is blocked by government firewall. From network perspective what we need is to route our traffic, or information flow, through some server in internet. This server should be reachable by us and at the same time this resource should be able to access the resource that is blocked in our home network.</p><p>Suppose we have our virtual private server (VPS) with public IP address <code>55.55.55.55</code>: we can directly access it and from this we can connect to our <code>blocked</code> resource. The preferable route of the traffic is shown in violet. If we do not have this route we will be never able to get to our <code>blocked</code> destination.</p><p><img src=./preferable-route.svg#center alt=svg></p><h2 id=option-1-outline>Option 1: Outline
<a class=heading-link href=#option-1-outline><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>One of the easiest solutions is to install <code>Outline</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> on your private: it allows to easily create and manage your own VPN server. The whole pipeline consists of three steps:</p><ol><li>Install <code>Outline Manager</code> on your VPS.</li><li>Generate access keys and distribute them across the clients (friends, family, etc.).</li><li>Clients connect to VPN using these keys and <code>Outline Client</code> app for their favourite platform (Windows, Linux, Android).</li></ol><p>The how-to for <code>Outline</code> is described <a href=https://getoutline.org/ru/get-started/ class=external-link target=_blank rel=noopener>here</a>.</p><h2 id=option-2-xray-or-v2ray>Option 2: XRay or V2Ray
<a class=heading-link href=#option-2-xray-or-v2ray><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>XRay</code><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> is the successor of <code>V2Ray</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> &ndash; the collection of tools that help users build their own basic communication networks. In China this tool is very popular for bypassing the Great Firewall and accessing the blocked content. <code>XRay</code> works as proxy tool: it starts the local proxy on client machine and routes all the traffic from this proxy to one or another destination.</p><p>The configuration and route rules are very flexible: requests can be re-routed based on their target ip, domain or even protocol. New rules can be created very easily. The killer-feature of <code>XRay</code> for me is <em>its ability to re-route only the requests to blocked websites</em> through VPS and directly access all the others.</p><h3 id=server-setup>Server setup
<a class=heading-link href=#server-setup><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Issue the following command<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> on your server:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bash -c <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#fff;font-weight:700>$(</span>curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh<span style=color:#fff;font-weight:700>)</span><span style=color:#0ff;font-weight:700>&#34;</span> @ install-geodata
</span></span></code></pre></div><p>Verify that the configuration file <code>/usr/local/etc/xray/config.json</code> was created. Create more clients if required:<div class=spoiler><span class=spoilerText>Spoiler</span>
<input class=spoilerChecked type=checkbox showtext=Code><div class=spoilerContent><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>&#34;inbounds&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;port&#34;</span>: <span style=color:#ff0;font-weight:700>11123</span>, <span style=color:#007f7f>// Port you want to use from server side, select freely
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>            <span style=font-weight:700>&#34;protocol&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;vmess&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;clients&#34;</span>: [
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=font-weight:700>&#34;id&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;37292d7c-ac1c-44ef-8c20-5864a6d62ac5&#34;</span> <span style=color:#007f7f>// Client 1, generate your own UUID
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=font-weight:700>&#34;id&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;9d5ca145-070e-4c88-92d7-a32a167dde6e&#34;</span> <span style=color:#007f7f>// Client 2, generate your own UUID
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                    }
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=font-weight:700>&#34;outbounds&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;protocol&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;freedom&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div></p><h3 id=client-setup>Client setup
<a class=heading-link href=#client-setup><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>For client we have to create <code>config.json</code> file and set up the configuration, then we can use this same file for all our clients (Linux, Windows, Android) and change only UUIDs. I will leave mine <code>config.json</code> here for convenience. Do not forget to change the configuration parameters.</p><p><div class=spoiler><span class=spoilerText>Spoiler</span>
<input class=spoilerChecked type=checkbox showtext=Code><div class=spoilerContent><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>&#34;inbounds&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;port&#34;</span>: <span style=color:#ff0;font-weight:700>10808</span>,          <span style=color:#007f7f>// Port for proxy on client side, you can use your own
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>            <span style=font-weight:700>&#34;listen&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;protocol&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;socks&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;udp&#34;</span>: <span style=color:#fff;font-weight:700>true</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;sniffing&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;enabled&#34;</span>: <span style=color:#fff;font-weight:700>true</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;destOverride&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;tls&#34;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=font-weight:700>&#34;outbounds&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;protocol&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;freedom&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;tag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;direct&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;protocol&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;vmess&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;vnext&#34;</span>: [
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=font-weight:700>&#34;address&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;55.55.55.55&#34;</span>, <span style=color:#007f7f>// IP address of our VPS server
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                        <span style=font-weight:700>&#34;port&#34;</span>: <span style=color:#ff0;font-weight:700>11123</span>,            <span style=color:#007f7f>// Port on the server
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                        <span style=font-weight:700>&#34;users&#34;</span>: [
</span></span><span style=display:flex><span>                            {
</span></span><span style=display:flex><span>                                <span style=font-weight:700>&#34;id&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;37292d7c-ac1c-44ef-8c20-5864a6d62ac5&#34;</span> <span style=color:#007f7f>// You have to change it for other users
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                            }
</span></span><span style=display:flex><span>                        ]
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;tag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;vpn&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;protocol&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;blackhole&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;settings&#34;</span>: {},
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#34;tag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;block&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=font-weight:700>&#34;routing&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=font-weight:700>&#34;domainStrategy&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;IPIfNonMatch&#34;</span>,
</span></span><span style=display:flex><span>        <span style=font-weight:700>&#34;rules&#34;</span>: [
</span></span><span style=display:flex><span>            {   <span style=color:#007f7f>// Rule 1: we want to route all ads to tag &#39;block&#39;
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                <span style=font-weight:700>&#34;type&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;field&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;outboundTag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;block&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;domain&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:category-ads-all&#34;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#007f7f>// Rule 2: we want to access all internal networks directly
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                <span style=font-weight:700>&#34;type&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;field&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;outboundTag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;direct&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;ip&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geoip:private&#34;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#007f7f>// Rule 3: we also want to acess some resources directly
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                <span style=font-weight:700>&#34;type&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;field&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;outboundTag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;direct&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;domain&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;domain:leroymerlin.ru&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:yandex&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;domain:mirconnect.ru&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;domain:vk.com&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;domain:sberbank.ru&#34;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#007f7f>// Rule 4: the list of resources that have to be routed to our vpn tag.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>                <span style=font-weight:700>&#34;type&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;field&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;outboundTag&#34;</span>: <span style=color:#0ff;font-weight:700>&#34;vpn&#34;</span>,
</span></span><span style=display:flex><span>                <span style=font-weight:700>&#34;domain&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;domain:meduza.io&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;domain:istories.media&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:twitter&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:facebook&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:instagram&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:category-media&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#0ff;font-weight:700>&#34;geosite:category-entertainment&#34;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div>Depending on the target platform the following setup options are available:</p><ul><li><strong>Linux</strong> &ndash; install <code>XRay</code> in the same manner as for server, edit the <code>/usr/local/etc/xray/config.json</code> as described earlier, use <code>systemctl restart xray</code> or <code>service xray restart</code> if something goes wrong.</li><li><strong>Windows</strong> &ndash; download the binaries from <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>, add binary to autostart while providing the path to <code>config.json</code> file.</li><li><strong>Android</strong> &ndash; download APK from <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>, install, import <code>config.json</code>.</li></ul><h2 id=option-3-wireguard>Option 3: Wireguard
<a class=heading-link href=#option-3-wireguard><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>As another option we can use <code>Wireguard</code><sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup> to organize the tunnels between our VPS and host to bypass the restrictions. Another benefit of <code>Wireguard</code> is the easiness of deployment site-to-site VPN. Connecting several distant local area networks (LAN - for example your home and villiage networks behind routers) using VPN has the following benefits:</p><ol><li>we can access the clients of all LANs directly by internal IPs;</li><li>we can forward not all the traffic through VPN, but only the traffic between our LANs, while accessing all the other website directly, without loading our VPS server.</li></ol><p>Let&rsquo;s assume we want to connect our home network (<code>192.168.101.0/24</code> subnet), countryhouse network (<code>192.168.102.0/24</code> subnet) and the laptop. The two LANs are managed by OpenWrt routers. As initial request we want our VPN to tunnel only LAN-to-LAN traffic. If in future we want to tunnel all the traffic through VPN we will have change only one line in our configuration, I will show which one.</p><p>Our VPS server has the same IP address <code>55.55.55.55</code> and we allocate <code>10.3.2.0/24</code> subnet for wireguard network. The scheme of our network is shown here:</p><p><img src=./wireguard.svg#center alt=svg></p><p>Having this setup we can access <code>192.168.102.0/24</code> hosts while being connected to <code>192.168.101.0/24</code> network and vice-versa. For example, we can access CCTV camera from our PC, and access the printer from the laptop. If we are connected to our OpenWrt routers (<code>192.168.101.1</code> and <code>192.168.102.1</code>) we do not even need to set up a wireguard tunnel to our VPS, OpenWrt will handle all the connections. If we are outside our routers, we will have to connect to our VPN using wireguard client for PC or smartphone.</p><h3 id=server-setup-1>Server setup
<a class=heading-link href=#server-setup-1><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Install wireguard on the server:allow traffic forwarding between interfaces:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install wireguard
</span></span></code></pre></div><p>allow traffic forwarding between interfaces and enable proxy ARP:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sysctl -w net.ipv4.ip_forward=<span style=color:#ff0;font-weight:700>1</span>
</span></span><span style=display:flex><span>sudo sysctl -w net.ipv4.conf.all.proxy_arp=<span style=color:#ff0;font-weight:700>1</span>
</span></span></code></pre></div><p>Create and set up the config file for wireguard (<code>/etc/wireguard/wg0.conf</code>), where <code>EXTERNAL_ETHERNET</code> is the main internet interface on your server:<div class=spoiler><span class=spoilerText>Spoiler</span>
<input class=spoilerChecked type=checkbox showtext=Code><div class=spoilerContent><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[Interface]
</span></span><span style=display:flex><span>Address = 10.3.2.1/24
</span></span><span style=display:flex><span>ListenPort = <span style=color:#ff0;font-weight:700>51820</span>
</span></span><span style=display:flex><span>MTU = <span style=color:#ff0;font-weight:700>1420</span>
</span></span><span style=display:flex><span>PrivateKey = YOUR_PRIVATE_KEY
</span></span><span style=display:flex><span>PostUp = sysctl --write net.ipv4.ip_forward=1; sysctl --write net.ipv6.conf.all.forwarding=1; nft add table inet wireguard-wg0; nft add chain inet wireguard-wg0 wireguard_chain {<span style=color:#fff;font-weight:700>type</span> nat hook postrouting priority srcnat<span style=color:#0ff;font-weight:700>\;</span>}; nft add rule inet wireguard-wg0 wireguard_chain oifname EXTERNAL_ETHERNET masquerade
</span></span><span style=display:flex><span>PostDown = sysctl --write net.ipv4.ip_forward=0; sysctl --write net.ipv6.conf.all.forwarding=0; nft delete table inet wireguard-wg0
</span></span><span style=display:flex><span>SaveConfig = <span style=color:#fff;font-weight:700>false</span>
</span></span><span style=display:flex><span><span style=color:#007f7f># OpenWrt 192.168.101.0/24 config</span>
</span></span><span style=display:flex><span>[Peer]
</span></span><span style=display:flex><span>PublicKey = YOUR_CLIENT_PUBLIC_KEY_1
</span></span><span style=display:flex><span>PresharedKey = YOUR_PRESHARED_KEY_1
</span></span><span style=display:flex><span>AllowedIPs = 10.3.2.2/32,192.168.101.0/24
</span></span><span style=display:flex><span><span style=color:#007f7f># OpenWrt 192.168.102.0/24 config</span>
</span></span><span style=display:flex><span>[Peer]
</span></span><span style=display:flex><span>PublicKey = YOUR_CLIENT_PUBLIC_KEY_2
</span></span><span style=display:flex><span>PresharedKey = YOUR_PRESHARED_KEY_2
</span></span><span style=display:flex><span>AllowedIPs = 10.3.2.3/32,192.168.102.0/24
</span></span><span style=display:flex><span><span style=color:#007f7f># Laptop config</span>
</span></span><span style=display:flex><span>[Peer]
</span></span><span style=display:flex><span>PublicKey = YOUR_CLIENT_PUBLIC_KEY_3
</span></span><span style=display:flex><span>PresharedKey = YOUR_PRESHARED_KEY_3
</span></span><span style=display:flex><span>AllowedIPs = 10.3.2.4/32
</span></span><span style=display:flex><span><span style=color:#007f7f># laptop end</span>
</span></span></code></pre></div></div></div>Replace all the keys with your own, generated by <code>wg genkey</code> command. Note that every client has unique <em>public</em> and <em>preshared</em> keys.</p><h3 id=client-setup-1>Client setup
<a class=heading-link href=#client-setup-1><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Create configs for your clients, note the <code>AllowedIPs</code> section, they differ depending on the client, <code>OpenWrt 1</code> config:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#007f7f># Openwrt 192.168.101.1</span>
</span></span><span style=display:flex><span>[Interface]
</span></span><span style=display:flex><span>Address = 10.3.2.2/32
</span></span><span style=display:flex><span>DNS = 10.3.2.1
</span></span><span style=display:flex><span>ListenPort = <span style=color:#ff0;font-weight:700>29516</span>
</span></span><span style=display:flex><span>MTU = <span style=color:#ff0;font-weight:700>1280</span>
</span></span><span style=display:flex><span>PrivateKey = YOUR_PRIVATE_KEY
</span></span><span style=display:flex><span>[Peer]
</span></span><span style=display:flex><span>AllowedIPs = 192.168.102.0/24,10.3.2.0/24
</span></span><span style=display:flex><span>Endpoint = YOUR_SERVER_IP:51820
</span></span><span style=display:flex><span>PersistentKeepalive = <span style=color:#ff0;font-weight:700>25</span>
</span></span><span style=display:flex><span>PresharedKey = YOUR_PRESHARED_KEY_1
</span></span><span style=display:flex><span>PublicKey = YOUR_CLIENT_PUBLIC_KEY_1
</span></span></code></pre></div><p><code>OpenWrt 2</code> config:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#007f7f># Openwrt 192.168.102.1</span>
</span></span><span style=display:flex><span>[Interface]
</span></span><span style=display:flex><span>Address = 10.3.2.3/32
</span></span><span style=display:flex><span>DNS = 10.3.2.1
</span></span><span style=display:flex><span>ListenPort = <span style=color:#ff0;font-weight:700>29341</span>
</span></span><span style=display:flex><span>MTU = <span style=color:#ff0;font-weight:700>1280</span>
</span></span><span style=display:flex><span>PrivateKey = YOUR_PRIVATE_KEY
</span></span><span style=display:flex><span>[Peer]
</span></span><span style=display:flex><span>AllowedIPs = 192.168.101.0/24,10.3.2.0/24
</span></span><span style=display:flex><span>Endpoint = YOUR_SERVER_IP:51820
</span></span><span style=display:flex><span>PersistentKeepalive = <span style=color:#ff0;font-weight:700>25</span>
</span></span><span style=display:flex><span>PresharedKey = YOUR_PRESHARED_KEY_2
</span></span><span style=display:flex><span>PublicKey = YOUR_CLIENT_PUBLIC_KEY_2
</span></span></code></pre></div><p><code>Laptop</code> config:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#007f7f># Laptop 10.3.2.4</span>
</span></span><span style=display:flex><span>[Interface]
</span></span><span style=display:flex><span>Address = 10.3.2.4/32
</span></span><span style=display:flex><span>DNS = 10.3.2.1
</span></span><span style=display:flex><span>ListenPort = <span style=color:#ff0;font-weight:700>54921</span>
</span></span><span style=display:flex><span>MTU = <span style=color:#ff0;font-weight:700>1280</span>
</span></span><span style=display:flex><span>PrivateKey = YOUR_PRIVATE_KEY
</span></span><span style=display:flex><span>[Peer]
</span></span><span style=display:flex><span>AllowedIPs = 192.168.101.0/24,192.168.102.0/24,10.3.2.0/24
</span></span><span style=display:flex><span>Endpoint = YOUR_SERVER_IP:51820
</span></span><span style=display:flex><span>PersistentKeepalive = <span style=color:#ff0;font-weight:700>25</span>
</span></span><span style=display:flex><span>PresharedKey = YOUR_PRESHARED_KEY_3
</span></span><span style=display:flex><span>PublicKey = YOUR_CLIENT_PUBLIC_KEY_3
</span></span></code></pre></div><p>If you want to send all the traffic through VPN tunnel, just change <code>AllowedIPs</code> string on the client to <code>0.0.0.0/0</code>.</p><p>While rolling out this setup on <code>OpenWrt</code> I created the special <code>VPN</code> zone for firewall and assigned this zone to wireguard interface. The rules of the zone are the following:</p><ul><li><code>VPN</code> => <code>LAN</code>: accept input, accept output, accept forward, allow masquerading;</li><li><code>LAN</code> => <code>VPN</code>: accept input, accept output, accept forward.</li></ul><p>The OpenWrt will start up the wireguard automatically. If you want to start the wireguard tunnel on you laptop copy the config to <code>/etc/wireguard/wg0.conf</code> and issue the command:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo wg-quick up wg0
</span></span></code></pre></div><p>Now you should be able to ping and traceroute all the other LAN-clients succesfully (if everything works, of course):</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>laptop$ traceroute 192.168.102.135
</span></span><span style=display:flex><span>traceroute to 192.168.102.135 (192.168.102.135), <span style=color:#ff0;font-weight:700>30</span> hops max, <span style=color:#ff0;font-weight:700>60</span> byte packets
</span></span><span style=display:flex><span> <span style=color:#ff0;font-weight:700>1</span>  10.3.2.1 (10.3.2.1)  144.531 ms  145.366 ms  145.247 ms
</span></span><span style=display:flex><span> <span style=color:#ff0;font-weight:700>2</span>  10.3.2.3 (10.3.2.3)  233.145 ms  233.032 ms  233.023 ms
</span></span><span style=display:flex><span> <span style=color:#ff0;font-weight:700>3</span>  192.168.102.135 (192.168.102.135)  246.700 ms  250.677 ms  250.604 ms
</span></span></code></pre></div><h3 id=wireguard-obfuscation>Wireguard obfuscation
<a class=heading-link href=#wireguard-obfuscation><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Since WireGuard is frequently blocked by traffic analysis systems, obfuscating its traffic is often necessary.</p><p>This can be achieved by installing the Shadowsocks server and client components on all machines<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>, and then obfuscating WireGuard packets<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>.</p><h1 id=links>Links
<a class=heading-link href=#links><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://getoutline.org/ class=external-link target=_blank rel=noopener>https://getoutline.org/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/XTLS/Xray-core class=external-link target=_blank rel=noopener>https://github.com/XTLS/Xray-core</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.v2fly.org/en_US/ class=external-link target=_blank rel=noopener>https://www.v2fly.org/en_US/</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://github.com/XTLS/Xray-install class=external-link target=_blank rel=noopener>https://github.com/XTLS/Xray-install</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://github.com/XTLS/Xray-core/releases class=external-link target=_blank rel=noopener>https://github.com/XTLS/Xray-core/releases</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/2dust/v2rayNG/releases class=external-link target=_blank rel=noopener>https://github.com/2dust/v2rayNG/releases</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://www.wireguard.com/ class=external-link target=_blank rel=noopener>https://www.wireguard.com/</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://openwrt.org/docs/guide-user/services/proxy/shadowsocks class=external-link target=_blank rel=noopener>https://openwrt.org/docs/guide-user/services/proxy/shadowsocks</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p><a href=https://errande.com/2021/07/obfuscate-wireguard/ class=external-link target=_blank rel=noopener>https://errande.com/2021/07/obfuscate-wireguard/</a>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mikoff-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2024
Aleksandr Mikoff
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>